{% extends 'base.html' %}

{% block content %}
<!-- 日記内容 -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <h3>{{ day.title }}</h3>
      <small class="text-muted">作成者: {{ day.author.username }} | {{ day.date|date:"Y-m-d H:i" }}</small>
    </div>
    {% if is_owner %}
    <div>
      <a href="{% url 'diary:update' day.pk %}" class="btn btn-sm btn-outline-primary">編集</a>
      <a href="{% url 'diary:delete' day.pk %}" class="btn btn-sm btn-outline-danger">削除</a>
    </div>
    {% endif %}
  </div>
  <div class="card-body">
    <p>{{ day.text|linebreaksbr }}</p>
  </div>
</div>

<!-- メッセージ表示 -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="close" data-dismiss="alert">
        <span>&times;</span>
      </button>
    </div>
  {% endfor %}
{% endif %}

<!-- コメント投稿フォーム（レビュアーのみ） -->
{% if comment_form %}
<div class="card mb-4">
  <div class="card-header">
    <h5>コメントを投稿</h5>
  </div>
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      <div class="form-group">
        {{ comment_form.text.label_tag }}
        {{ comment_form.text }}
        {% if comment_form.text.errors %}
          <div class="text-danger">
            {{ comment_form.text.errors }}
          </div>
        {% endif %}
      </div>
      <button type="submit" class="btn btn-primary">コメント投稿</button>
    </form>
  </div>
</div>
{% endif %}

<!-- コメント一覧 -->
{% if comments or is_owner %}
<div class="card">
  <div class="card-header">
    <h5>コメント ({{ comments.count }}件)</h5>
  </div>
  <div class="card-body">
    {% if comments %}
      {% for comment in comments %}
        <div class="border-bottom mb-3 pb-3">
          <div class="d-flex justify-content-between">
            <strong>{{ comment.author.username }}</strong>
            <small class="text-muted">{{ comment.created_at|date:"Y-m-d H:i" }}</small>
          </div>
          <p class="mt-2">{{ comment.text|linebreaksbr }}</p>
          
          <!-- 返信コメント表示 -->
          {% if comment.replies.all %}
            <div class="ml-4 mt-2">
              {% for reply in comment.replies.all %}
                <div class="border-left pl-3 mb-2">
                  <div class="d-flex justify-content-between">
                    <strong>{{ reply.author.username }}</strong>
                    <small class="text-muted">{{ reply.created_at|date:"Y-m-d H:i" }}</small>
                  </div>
                  <p class="mt-1">{{ reply.text|linebreaksbr }}</p>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">まだコメントがありません。</p>
    {% endif %}
  </div>
</div>
{% endif %}

<div class="mt-3">
  {% if is_owner %}
    <a href="{% url 'diary:index' %}" class="btn btn-secondary">日記一覧に戻る</a>
  {% endif %}
  {% if is_reviewer %}
    <a href="{% url 'diary:review' %}" class="btn btn-secondary">レビュー一覧に戻る</a>
  {% endif %}
</div>
{% endblock %}